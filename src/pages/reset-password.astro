---
import Layout from "@/layouts/Layout.astro";
import { ResetPasswordForm } from "@/components/auth/ResetPasswordForm";

export const prerender = false;

// Password reset can use either:
// 1. PKCE flow: ?code=... (modern, more secure)
// 2. Hash-based tokens: #access_token=...&type=recovery (legacy)
const url = new URL(Astro.request.url);
const error = url.searchParams.get("error");
const errorCode = url.searchParams.get("error_code");
const errorDescription = url.searchParams.get("error_description");
const code = url.searchParams.get("code");

let pageError: string | null = null;
let sessionEstablished = false;

// Check for errors from Supabase redirect
if (error || errorCode) {
  if (errorCode === "otp_expired") {
    pageError = "This password reset link has expired. Please request a new one.";
  } else {
    pageError = errorDescription || "Invalid reset link. Please request a new one.";
  }
}
// Check if we have an existing session (user already clicked the link)
else if (Astro.locals.session) {
  sessionEstablished = true;
}
// Check if we have a PKCE code - will be handled client-side
else if (code) {
  // Session will be established client-side via the exchange-code endpoint
}
// No error, no session, no code - user will need to establish session from hash token
---

<Layout title="Reset Password - 10xCards">
  <main class="min-h-screen flex items-center justify-center p-4">
    <ResetPasswordForm client:idle sessionEstablished={sessionEstablished} pageError={pageError} />
  </main>
</Layout>
